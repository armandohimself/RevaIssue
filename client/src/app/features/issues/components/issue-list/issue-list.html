<div class="issues-container">
  <div class="header">
    <div>
      <h2>Issues</h2>
      <p>Track and manage project defects and tasks.</p>
    </div>
    @if (roleService.canCreateIssue()) {
    <button mat-raised-button color="primary" (click)="onCreateIssue()">
      <mat-icon>add</mat-icon>
      Create Issue
    </button>
    }
  </div>
  <mat-card class="project-section">
    <mat-card-content>
      <mat-form-field appearance="outline" class="project-select">
        <mat-label>Project</mat-label>
        <mat-select [(ngModel)]="selectedProjectId" (selectionChange)="onProjectChange()">
          <mat-option value="">Select a Project</mat-option>
          @for (project of projects(); track project.projectId) {
          <mat-option [value]="project.projectId">{{ project.projectName }}</mat-option>
          }
        </mat-select>
      </mat-form-field>
      @if (getSelectedProjectName()) {
      <h3 class="project-title">{{ getSelectedProjectName() }}</h3>
      }
    </mat-card-content>
  </mat-card>
  <div class="filters">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Search issues</mat-label>
      <input matInput [(ngModel)]="searchText" />
      <mat-icon matPrefix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Status</mat-label>
      <mat-select [(ngModel)]="statusFilter">
        <mat-option value="">All Statuses</mat-option>
        <mat-option value="OPEN">Open</mat-option>
        <mat-option value="IN_PROGRESS">In Progress</mat-option>
        <mat-option value="RESOLVED">Resolved</mat-option>
        <mat-option value="CLOSED">Closed</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Severity</mat-label>
      <mat-select [(ngModel)]="severityFilter">
        <mat-option value="">All Severities</mat-option>
        <mat-option value="INFORMATIONAL">Informational</mat-option>
        <mat-option value="LOW">Low</mat-option>
        <mat-option value="MEDIUM">Medium</mat-option>
        <mat-option value="HIGH">High</mat-option>
        <mat-option value="CRITICAL">Critical</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Priority</mat-label>
      <mat-select [(ngModel)]="priorityFilter">
        <mat-option value="">All Priorities</mat-option>
        <mat-option value="LOW">Low</mat-option>
        <mat-option value="MEDIUM">Medium</mat-option>
        <mat-option value="HIGH">High</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <div class="issues-header">
    <span>ID</span>
    <span>Title</span>
    <span>Status</span>
    <span>Severity</span>
    <span>Priority</span>
    <span>Assigned To</span>
    <span>Created By</span>
    <span>Actions</span>
  </div>

  <div class="issues-list">
    @for (issue of getFilteredIssues(); track issue.issueId) {
    <app-issue-card [issue]="issue" (click)="onViewIssue(issue)" (editclick)="onEditIssue($event)">
    </app-issue-card>
    }
  </div>

  @if (getFilteredIssues().length === 0) {
  <p>No issues found.</p>
  }
</div>

@if (selectedIssue()) {
<app-issue-view-card [issue]="selectedIssue()!" (closecard)="onCloseViewCard()">
</app-issue-view-card>
} @if (showCreateCard()) {
<app-issue-create-card [projectId]="selectedProjectId" (closecard)="onCloseCreateCard()">
</app-issue-create-card>
} @if (editingIssue()) {
<app-issue-edit-card [issue]="editingIssue()!" (closecard)="onCloseEditCard()">
</app-issue-edit-card>
}
